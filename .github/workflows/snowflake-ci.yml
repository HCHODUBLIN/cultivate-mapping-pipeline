name: Snowflake CI

on:
  push:
    branches: [main]
    paths:
      - 'models/**'
      - 'snowflake/**'
      - 'dbt_project.yml'
  pull_request:
    branches: [main]
    paths:
      - 'models/**'
      - 'snowflake/**'
      - 'dbt_project.yml'

env:
  DBT_PROFILES_DIR: ${{ github.workspace }}

jobs:
  # Job 1: SQL Lint (항상 실행)
  sql-lint:
    name: SQL Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install sqlfluff
        run: pip install sqlfluff sqlfluff-templater-dbt

      - name: Lint SQL files
        run: |
          sqlfluff lint models/ --dialect snowflake --exclude-rules LT05,LT12 || true
          echo "::notice::SQL lint completed (warnings only, not blocking)"

  # Job 2: dbt Build & Test (Snowflake 연결)
  dbt-snowflake:
    name: dbt Snowflake Test
    runs-on: ubuntu-latest
    needs: sql-lint
    # main 브랜치 push 또는 PR label이 'run-snowflake-tests'일 때만 실행
    if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'run-snowflake-tests')

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dbt-snowflake
        run: |
          pip install dbt-snowflake==1.7.0

      - name: Create profiles.yml
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml << 'EOF'
          cultivate:
            target: ci
            outputs:
              ci:
                type: snowflake
                account: ${{ secrets.SNOWFLAKE_ACCOUNT }}
                user: ${{ secrets.SNOWFLAKE_USER }}
                password: ${{ secrets.SNOWFLAKE_PASSWORD }}
                role: ${{ secrets.SNOWFLAKE_ROLE }}
                database: ${{ secrets.SNOWFLAKE_DATABASE }}
                warehouse: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
                schema: CI_TEST_${{ github.run_id }}
                threads: 4
          EOF

      - name: dbt deps
        run: dbt deps

      - name: dbt debug
        run: dbt debug

      - name: dbt build (run + test)
        run: dbt build --select state:modified+ --defer --state ./target

      - name: Cleanup CI schema
        if: always()
        run: |
          dbt run-operation drop_ci_schema --args '{"schema_name": "CI_TEST_${{ github.run_id }}"}'
        continue-on-error: true
